rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    // Check if user is super admin (from adminUsers collection)
    function isSuperAdmin() {
      return isAuthenticated() && (
        exists(/databases/$(database)/documents/adminUsers/$(request.auth.uid)) ||
        (request.auth.email != null && exists(/databases/$(database)/documents/adminUsers/$(request.auth.email.split('@')[0]))) ||
        exists(/databases/$(database)/documents/adminUsers/sanchariadmin)
      );
    }
    
    // Check if user is super admin via users collection
    function isSuperAdminByAccountType() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountType == 'superAdmin';
    }
    
    // Combined super admin check
    function isSuperAdminCombined() {
      return isSuperAdmin() || isSuperAdminByAccountType();
    }
    
    // ============================================
    // Users Collection
    // ============================================
    match /users/{uid} {
      // Allow read for authenticated users
      allow read: if isAuthenticated();
      
      // Allow create for new users during signup
      allow create: if isAuthenticated() && 
                     request.auth.uid == uid &&
                     (!('accountType' in request.resource.data) ||
                      request.resource.data.accountType == 'Traveler');
      
      // Allow update for own profile (except accountType and suspended)
      allow update: if isOwner(uid) && 
                 (!('accountType' in request.resource.data) ||
                  request.resource.data.accountType == resource.data.accountType) &&
                 (!('suspended' in request.resource.data) ||
                  request.resource.data.suspended == resource.data.suspended);
      
      // Super admin can update any user
      allow update: if isSuperAdminCombined();
      
      // Prevent deletion
      allow delete: if false;
      
      // Subcollections
      match /pendingVerifications/{docId} {
        allow read, write: if isOwner(uid) || isSuperAdminCombined();
        allow delete: if false;
      }
      
      match /favorites/{docId} {
        allow read, write: if isOwner(uid);
        allow delete: if false;
      }
    }
    
    // ============================================
    // Admin Users Collection
    // ============================================
    match /adminUsers/{adminId} {
      // Allow authenticated users to read (needed for checking admin status)
      allow read: if isAuthenticated();
      
      // Only super admins can create/update
      allow create, update: if isSuperAdminCombined();
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // ============================================
    // Verifications Collection
    // ============================================
    match /verifications/{verificationId} {
      // Super admins can read all, users can read their own
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        isSuperAdminByAccountType() ||
        resource.data.uid == request.auth.uid
      );
      
      // Users can create their own verification requests
      allow create: if isAuthenticated() && 
                     request.resource.data.uid == request.auth.uid;
      
      // Only super admins can update
      allow update: if isSuperAdminCombined();
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // ============================================
    // Upgrade Requests Collection
    // ============================================
    match /upgradeRequests/{requestId} {
      // Users can read their own, super admins can read all
      allow read: if isAuthenticated() && (
        isSuperAdminCombined() ||
        resource.data.uid == request.auth.uid
      );
      
      // Users can create upgrade requests
      allow create: if isAuthenticated() && 
                     request.resource.data.uid == request.auth.uid;
      
      // Only super admins can update
      allow update: if isSuperAdminCombined();
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // Legacy upgrade_requests collection
    match /upgrade_requests/{requestId} {
      allow read: if isAuthenticated() && (
        isSuperAdminCombined() ||
        resource.data.uid == request.auth.uid
      );
      allow create: if isAuthenticated() && 
                     request.resource.data.uid == request.auth.uid;
      allow update: if isSuperAdminCombined();
      allow delete: if false;
    }
    
    // ============================================
    // Posts Collection
    // ============================================
    match /posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
      
      // Reviews subcollection
      match /reviews/{reviewId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
        allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isSuperAdminCombined());
        allow delete: if isSuperAdminCombined();
      }
    }
    
    // ============================================
    // Trips Collection
    // ============================================
    match /trips/{tripId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    // ============================================
    // Reports Collection
    // ============================================
    match /reports/{reportId} {
      // Only super admins can read
      allow read: if isSuperAdminCombined();
      
      // Users can create reports
      allow create: if isAuthenticated() && 
                     request.resource.data.reportedBy == request.auth.uid;
      
      // Only super admins can update
      allow update: if isSuperAdminCombined();
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // ============================================
    // Content Collections
    // ============================================
    match /packages/{packageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /stays/{stayId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /rides/{rideId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /localTours/{tourId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /itineraries/{itineraryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /affiliateLinks/{linkId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /teamMembers/{memberId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /stories/{storyId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    // ============================================
    // Usernames Collection
    // ============================================
    match /usernames/{username} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // Role Requirements Collection
    // ============================================
    match /roleRequirements/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isSuperAdminCombined();
      allow delete: if false;
    }
    
    // ============================================
    // Health Check Collection
    // ============================================
    match /healthcheck/{docId} {
      allow read, write: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============================================
    // Comments Collection (if used separately)
    // ============================================
    match /comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    // ============================================
    // Messages Collection (for chat)
    // ============================================
    match /messages/{messageId} {
      allow read: if isAuthenticated() && 
                   (resource.data.senderId == request.auth.uid ||
                    resource.data.recipientId == request.auth.uid ||
                    isSuperAdminCombined());
      allow create: if isAuthenticated() && 
                     request.resource.data.senderId == request.auth.uid;
      allow update: if isSuperAdminCombined();
      allow delete: if isSuperAdminCombined();
    }
    
    // ============================================
    // Follows Collection
    // ============================================
    match /follows/{followId} {
      // Users can read all follows (needed for feed queries)
      allow read: if isAuthenticated();
      
      // Users can create follows only for themselves
      allow create: if isAuthenticated() && 
                     request.resource.data.followerId == request.auth.uid &&
                     request.resource.data.followingId != request.auth.uid; // Prevent self-follow
      
      // Users can delete only their own follows
      allow delete: if isAuthenticated() && 
                     resource.data.followerId == request.auth.uid;
      
      // Prevent updates (follows are immutable)
      allow update: if false;
    }
    
    // ============================================
    // Suggestions Cache Collection (optional)
    // ============================================
    match /suggestions_cache/{userId} {
      // Users can read their own cache
      allow read: if isAuthenticated() && userId == request.auth.uid;
      
      // Only server (Cloud Functions) can write
      allow write: if false; // Managed by Cloud Functions only
    }
    
    // ============================================
    // Default Deny (for any other collections)
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
