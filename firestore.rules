rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    // Check if user is super admin (from adminUsers collection)
    // Note: exists() returns false if document doesn't exist (doesn't throw error)
    function isSuperAdmin() {
      return isAuthenticated() && (
        exists(/databases/$(database)/documents/adminUsers/$(request.auth.uid)) ||
        (request.auth.email != null && 
         request.auth.email.split('@').size() > 0 &&
         exists(/databases/$(database)/documents/adminUsers/$(request.auth.email.split('@')[0]))) ||
        exists(/databases/$(database)/documents/adminUsers/sanchariadmin)
      );
    }
    
    // Check if user is super admin via users collection
    function isSuperAdminByAccountType() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountType == 'superAdmin';
    }
    
    // Combined super admin check
    function isSuperAdminCombined() {
      return isSuperAdmin() || isSuperAdminByAccountType();
    }
    
    // ============================================
    // Users Collection
    // ============================================
    match /users/{uid} {
      // Allow read for authenticated users
      allow read: if isAuthenticated();
      
      // Allow create for new users during signup
      allow create: if isAuthenticated() && 
                     request.auth.uid == uid &&
                     (!('accountType' in request.resource.data) ||
                      request.resource.data.accountType == 'Traveler');
      
      // Allow update for own profile (except accountType and suspended)
      allow update: if isOwner(uid) && 
                 (!('accountType' in request.resource.data) ||
                  request.resource.data.accountType == resource.data.accountType) &&
                 (!('suspended' in request.resource.data) ||
                  request.resource.data.suspended == resource.data.suspended);
      
      // Super admin can update any user
      allow update: if isSuperAdminCombined();
      
      // Prevent deletion
      allow delete: if false;
      
      // Subcollections
      match /pendingVerifications/{docId} {
        allow read, write: if isOwner(uid) || isSuperAdminCombined();
        allow delete: if false;
      }
      
      match /favorites/{docId} {
        allow read, write: if isOwner(uid);
        allow delete: if false;
      }
      
      // LastRead subcollection (for tracking read timestamps)
      match /lastRead/{docId} {
        allow read, write: if isOwner(uid);
        allow delete: if false;
      }
      
      // Chats subcollection (for copilot and other chats)
      match /chats/{chatId} {
        allow read, write: if isOwner(uid);
        allow delete: if false;
        
        // Messages subcollection within chats
        match /messages/{messageId} {
          allow read, write: if isOwner(uid);
          allow delete: if isOwner(uid) || isSuperAdminCombined();
        }
      }
    }
    
    // ============================================
    // Admin Users Collection
    // ============================================
    match /adminUsers/{adminId} {
      // Allow authenticated users to read (needed for checking admin status)
      allow read: if isAuthenticated();
      
      // Only super admins can create/update
      allow create, update: if isSuperAdminCombined();
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // ============================================
    // Verifications Collection
    // ============================================
    match /verifications/{verificationId} {
      // Super admins can read all, users can read their own
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        isSuperAdminByAccountType() ||
        resource.data.uid == request.auth.uid
      );
      
      // Users can create their own verification requests
      allow create: if isAuthenticated() && 
                     request.resource.data.uid == request.auth.uid;
      
      // Only super admins can update
      allow update: if isSuperAdminCombined();
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // ============================================
    // Upgrade Requests Collection
    // ============================================
    match /upgradeRequests/{requestId} {
      // Users can read their own, super admins can read all
      allow read: if isAuthenticated() && (
        isSuperAdminCombined() ||
        resource.data.uid == request.auth.uid
      );
      
      // Users can create upgrade requests
      allow create: if isAuthenticated() && 
                     request.resource.data.uid == request.auth.uid;
      
      // Only super admins can update
      allow update: if isSuperAdminCombined();
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // Legacy upgrade_requests collection
    match /upgrade_requests/{requestId} {
      allow read: if isAuthenticated() && (
        isSuperAdminCombined() ||
        resource.data.uid == request.auth.uid
      );
      allow create: if isAuthenticated() && 
                     request.resource.data.uid == request.auth.uid;
      allow update: if isSuperAdminCombined();
      allow delete: if false;
    }
    
    // ============================================
    // Posts Collection
    // ============================================
    match /posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
      
      // Reviews subcollection
      match /reviews/{reviewId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
        allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isSuperAdminCombined());
        allow delete: if isSuperAdminCombined();
      }
    }
    
    // ============================================
    // Trips Collection
    // ============================================
    match /trips/{tripId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    // ============================================
    // Reports Collection
    // ============================================
    match /reports/{reportId} {
      // Only super admins can read
      allow read: if isSuperAdminCombined();
      
      // Users can create reports
      allow create: if isAuthenticated() && 
                     request.resource.data.reportedBy == request.auth.uid;
      
      // Only super admins can update
      allow update: if isSuperAdminCombined();
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // ============================================
    // Content Collections
    // ============================================
    match /packages/{packageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /stays/{stayId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /rides/{rideId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /localTours/{tourId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /itineraries/{itineraryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /affiliateLinks/{linkId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /teamMembers/{memberId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    // ============================================
    // Stories Collections (V1 Refactor)
    // ============================================
    
    // 1. Stories metadata (Lean, no arrays)
    match /stories/{storyId} {
      allow read: if isAuthenticated();
      // Author creates
      allow create: if isAuthenticated() && 
                     request.resource.data.authorId == request.auth.uid; // Note: Changed to authorId per requirement
      // Author updates (status etc)
      allow update: if isAuthenticated() && 
                     resource.data.authorId == request.auth.uid;
      // Author or Super Admin deletes
      allow delete: if isAuthenticated() && 
                     (resource.data.authorId == request.auth.uid || isSuperAdminCombined());
    }
    
    // 2. Story Feeds (Fan-out target)
    match /story_feeds/{docId} {
      // User can read their own feed
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // No client writes allowed yet (managed by backend/functions eventually)
      allow write: if false; 
    }

    // 3. Story Views (Append-only tracking)
    match /story_views/{viewId} {
      // Author can read who viewed their story
      // Viewer can read their own views (checked in feed logic)
      allow read: if isAuthenticated() && 
                   (resource.data.viewerId == request.auth.uid || 
                    get(/databases/$(database)/documents/stories/$(resource.data.storyId)).data.authorId == request.auth.uid);
      
      // Viewer creates a view record
      allow create: if isAuthenticated() && 
                     request.resource.data.viewerId == request.auth.uid;
      
      // No updates or deletes allowed (immutable history)
      allow update, delete: if false;
    }
    
    // ============================================
    // Usernames Collection
    // ============================================
    match /usernames/{username} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // Role Requirements Collection
    // ============================================
    match /roleRequirements/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isSuperAdminCombined();
      allow delete: if false;
    }
    
    // ============================================
    // Health Check Collection
    // ============================================
    match /healthcheck/{docId} {
      allow read, write: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============================================
    // Comments Collection (if used separately)
    // ============================================
    match /comments/{commentId} {
      // All authenticated users can read comments
      allow read: if isAuthenticated();
      
      // Users can create their own comments
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid;
      
      // Comment owner or super admin can update
      allow update: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isSuperAdminCombined());
      
      // Comment owner or super admin can delete
      allow delete: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isSuperAdminCombined());
    }
    
    // ============================================
    // Messages Collection (for chat)
    // ============================================
    match /messages/{messageId} {
      allow read: if isAuthenticated() && 
                   (resource.data.senderId == request.auth.uid ||
                    resource.data.recipientId == request.auth.uid ||
                    isSuperAdminCombined());
      allow create: if isAuthenticated() && 
                     request.resource.data.senderId == request.auth.uid;
      allow update: if isSuperAdminCombined();
      allow delete: if isSuperAdminCombined();
    }
    
    // ============================================
    // Follows Collection
    // ============================================
    match /follows/{followId} {
      // Users can read all follows (needed for feed queries)
      allow read: if isAuthenticated();
      
      // Users can create follows only for themselves
      allow create: if isAuthenticated() && 
                     request.resource.data.followerId == request.auth.uid &&
                     request.resource.data.followingId != request.auth.uid; // Prevent self-follow
      
      // Users can delete only their own follows
      allow delete: if isAuthenticated() && 
                     resource.data.followerId == request.auth.uid;
      
      // Prevent updates (follows are immutable)
      allow update: if false;
    }
    
    // ============================================
    // Suggestions Cache Collection (optional)
    // ============================================
    match /suggestions_cache/{userId} {
      // Users can read their own cache
      allow read: if isAuthenticated() && userId == request.auth.uid;
      
      // Only server (Cloud Functions) can write
      allow write: if false; // Managed by Cloud Functions only
    }
    
    // ============================================
    // Likes Collection
    // ============================================
    match /likes/{likeId} {
      // All authenticated users can read (for like counts)
      allow read: if isAuthenticated();
      
      // Users can create their own likes
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid;
      
      // Users can delete only their own likes
      allow delete: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Prevent updates (likes are immutable)
      allow update: if false;
    }
    
    // ============================================
    // Notifications Collection
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications, super admins can read all
      allow read: if isAuthenticated() && (
        isSuperAdminCombined() ||
        resource.data.userId == request.auth.uid
      );
      
      // System can create notifications (via Cloud Functions recommended)
      allow create: if isAuthenticated();
      
      // Users can update their own notifications, super admins can update all
      allow update: if isAuthenticated() && (
        isSuperAdminCombined() ||
        resource.data.userId == request.auth.uid
      );
      
      // Prevent deletion (data persistence)
      allow delete: if false;
    }
    
    // Legacy notifications path (users/{userId}/notifications)
    match /users/{userId}/notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        isSuperAdminCombined() ||
        userId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        isSuperAdminCombined() ||
        userId == request.auth.uid
      );
      allow delete: if false;
    }
    
    // ============================================
    // Conversations Collection (for chat)
    // ============================================
    match /conversations/{conversationId} {
      // Participants can read their conversations
      allow read: if isAuthenticated() && (
        isSuperAdminCombined() ||
        request.auth.uid in resource.data.participants
      );
      
      // Users can create conversations they're part of
      allow create: if isAuthenticated() && 
                     request.auth.uid in request.resource.data.participants;
      
      // Participants can update conversations
      allow update: if isAuthenticated() && (
        isSuperAdminCombined() ||
        request.auth.uid in resource.data.participants
      );
      
      // Only super admins can delete
      allow delete: if isSuperAdminCombined();
      
      // Messages subcollection
      match /messages/{messageId} {
        // Participants can read messages
        allow read: if isAuthenticated() && (
          isSuperAdminCombined() ||
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants
        );
        
        // Participants can create messages
        allow create: if isAuthenticated() && 
                       request.resource.data.senderId == request.auth.uid &&
                       request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        // Only sender can update their own messages
        allow update: if isAuthenticated() && (
          isSuperAdminCombined() ||
          resource.data.senderId == request.auth.uid
        );
        
        // Sender or super admin can delete
        allow delete: if isAuthenticated() && (
          isSuperAdminCombined() ||
          resource.data.senderId == request.auth.uid
        );
      }
    }
    
    // ============================================
    // Groups Collection (for group chat)
    // ============================================
    match /groups/{groupId} {
      // Group members can read
      allow read: if isAuthenticated() && (
        isSuperAdminCombined() ||
        request.auth.uid in resource.data.members
      );
      
      // Authenticated users can create groups
      allow create: if isAuthenticated() && 
                     request.auth.uid in request.resource.data.members;
      
      // Group admins or super admins can update
      allow update: if isAuthenticated() && (
        isSuperAdminCombined() ||
        request.auth.uid in resource.data.admins ||
        request.auth.uid == resource.data.createdBy
      );
      
      // Only super admins can delete
      allow delete: if isSuperAdminCombined();
    }
    
    // ============================================
    // Reels Collection
    // ============================================
    match /reels/{reelId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                     request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && 
                     (resource.data.createdBy == request.auth.uid || isSuperAdminCombined());
      allow delete: if isSuperAdminCombined();
    }
    
    // ============================================
    // Traveller Cards Collection
    // ============================================
    match /traveller_cards/{userId} {
      // Users can read only their own Traveller Card
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Client writes are BLOCKED - only Cloud Functions (admin SDK) can write
      allow write: if false;
    }
    
    // ============================================
    // Default Deny (for any other collections)
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
